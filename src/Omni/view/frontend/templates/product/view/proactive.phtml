<?php
/** @var \Ls\Omni\Block\Product\View\Discount\Proactive $block */
// @codingStandardsIgnoreFile
?>
<div class="proactive-discounts-container" style="display:none">
    <?php
    $discounts = $block->getProactiveDiscounts();
    $coupons = $block->getCoupons();
    if (!empty($discounts) || !empty($coupons)) {
        ?>
        <div class="discount-dropdown-label">
            <span><?php echo __("Promotions:"); ?></span>
        </div>
        <div class="discount-dropdown">
            <div data-block="dropdown" class="dropdown-wrapper">
                <button type="button" class="action primary" data-trigger="trigger">
                    <span data-bind="i18n: 'Find Discounts'"></span>
                    <i class="arrow down"></i>
                </button>
            </div>
            <div class="block block-dropdown"
                 data-mage-init='{
        "dropdownDialog": {
            "appendTo": "[data-block=dropdown]",
            "triggerTarget":"[data-trigger=trigger]",
            "timeout": 2000,
            "closeOnMouseLeave": false,
            "closeOnEscape": true,
            "autoOpen": false,
            "triggerClass": "active",
            "parentClass": "active",
            "buttons": []
        }
     }'>
                <?php
                foreach ($coupons as $coupon) {
                    if ($coupon->getCode() == 'Coupon') {
                        echo "<div class='dropdown-content-wrapper content-coupon'>
                " . $block->getFormattedDescriptionCoupon($coupon) . "
            </div>";
                    }
                }
                foreach ($discounts as $discount) {
                    echo "<div class='dropdown-content-wrapper content-discount'>
                " . $block->getFormattedDescriptionDiscount($discount) . "
            </div>";
                }
                ?>

            </div>
        </div>
    <?php } ?>
</div>

<script type="text/javascript">
    require(['jquery', 'mage/gallery/gallery'], function($, gallery){
        var gallery = $('[data-gallery-role=gallery-placeholder]');
        var discounts = $('.catalog-product-view .proactive-discounts-container');
        if (gallery.length > 0) {
            gallery.on('gallery:loaded', function () {
                discounts.show();
            });
        } else {
            discounts.show();
        }

    });
</script>